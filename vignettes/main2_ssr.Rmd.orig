---
title: "State Space Reconstruction"
author: "Wenbo Lv"
date: |
  | Last update: 2026-02-01
  | Last run: `r Sys.Date()`
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{2. State Space Reconstruction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "##",
  fig.path = "man/figures/ssr/"
)
```

## Methodological Background

Takens theory proves that for a dynamical system $\phi$, if its trajectory converges to an attractor manifold $M$—a bounded and invariant set of states—then there exists a smooth mapping between the system $\phi$ and its attractor $M$. Consequently, the time series observations of $\phi$ can be used to reconstruct the structure of $M$ through delay embedding.

According to the generalized embedding theorem, for a compact $d$-dimensional manifold $M$ and a set of observation functions $\langle h_1, h_2, \ldots, h_L \rangle$, the mapping $\psi_{\phi,h}(x) = \langle h_1(x), h_2(x), \ldots, h_L(x) \rangle$ is an embedding of $M$ when $L \geq 2d + 1$. Here, *embedding* refers to a one-to-one map that resolves all singularities of the original manifold. The observation functions $h_i$ can take the form of time-lagged values from a single time series, lags from multiple time series, or even completely distinct measurements. The former two are simply special cases of the third.

This embedding framework can be extended to *spatial cross-sectional data*, which lack temporal ordering but are observed over a spatial domain. In this context, the observation functions can be defined using the values of a variable at a focal spatial unit and its surrounding neighbors (known as *spatial lags* in spatial statistics). Specifically, for a spatial unit $s$, the embedding can be written as:

$$
\psi(x, s) = \langle h_s(x), h_{s(1)}(x), \ldots, h_{s(L-1)}(x) \rangle,
$$

where $h_{s(i)}(x)$ denotes the observation function of the $i$-th order spatial lag unit relative to $s$. These spatial lags provide the necessary diversity of observations for effective manifold reconstruction. In practice, if a given spatial lag order involves multiple units, summary statistics such as the mean or directionally-weighted averages can be used as the observation function to maintain a one-to-one embedding.

## Usage examples

### Example of spatial vector data

Load the `spEDM` package and its county-level population density data:

```{r load_lattice_data}
library(spEDM)

popd_nb = spdep::read.gal(system.file("case/popd_nb.gal",package = "spEDM"))
popd = readr::read_csv(system.file("case/popd.csv",package = "spEDM"))
popd_sf = sf::st_as_sf(popd, coords = c("lon","lat"), crs = 4326)
popd_sf
```

Embedding the variable `popd` from county-level population density:

```{r embed_lattice_data}
v = spEDM::embedded(popd_sf,"popd",E = 10)
v[1:5,c(4,5,10)]
```

```{r fig1,fig.width=4.25,fig.height=4.5,fig.dpi=100,fig.cap=knitr::asis_output("**Figure 1**. The reconstructed attractors for the variable `popd`.")}
plot3D::scatter3D(v[,4], v[,5], v[,10], colvar = NULL, pch = 19,
                  col = "red", theta = 45, phi = 10, cex = 0.35,
                  bty = "f", clab = NA, tickmarks = FALSE)
```

<br>

### Example of spatial raster data

Load the `spEDM` package and its farmland npp data:

```{r load_grid_data}
library(spEDM)

npp = terra::rast(system.file("case/npp.tif", package = "spEDM"))
npp
```

Embedding the variable `npp` from farmland npp data:

```{r embed_grid_data}
r = spEDM::embedded(npp,"npp",E = 5,tau = 20)
r[which(!is.na(r),arr.ind = T)[1:5],1:3]
```

```{r fig2,fig.width=4.25,fig.height=4.5,fig.dpi=100,fig.cap=knitr::asis_output("**Figure 2**. The reconstructed attractors for the variable `npp`.")}
plot3D::scatter3D(r[,1], r[,2], r[,3], colvar = NULL, pch = 19,
                  col = "#e77854", theta = 45, phi = 10, cex = 0.01,
                  bty = "f", clab = NA, tickmarks = FALSE)
```
